# 当前任务说明 (Current Mission)

## 核心任务：Supabase 集成与功能完善
当前开发工作的核心是接入 Supabase 完善数据层，并在此基础上实现角色切换、存档和配置管理。

## 详细开发任务清单
1. **角色切换系统**:
   - 建立 Role ID 索引机制。
   - 实现不同角色的 Session 上下文隔离。
   - 对接 Supabase `characters` 表读取角色设定。

2. **数据持久化与迁移**:
   - **聊天记录**: 实现 Message 级别的全量落库（Supabase），区别于 Redis 的上下文缓存。
   - **配置迁移**: 将环境变量/本地配置迁移至 Supabase，建立 Redis 缓存 + 定期刷新机制。

3. **快照系统 (Snapshot)**:
   - 开发“保存对话”按钮交互逻辑。
   - 实现基于特定 message_id 的上下文恢复/Fork 功能。

4. **运营与发布**:
   - 开发 Telegram 频道自动发帖工具（读取 Supabase 角色 -> 生成预览 -> 发送到频道）。
   - 实现 Deep Link 逻辑：用户点击频道按钮 -> 触发 Bot 切换角色。

5. **并发控制**:
   - 实现用户消息队列或锁机制，处理“连续发送两条消息”的竞态条件。

## 架构原则
- **读写分离**: 高频热数据（Session/Config Cache）走 Redis，持久化冷数据走 Supabase。
- **无状态服务**: Bot 实例应保持无状态，所有状态依赖外部存储，支持横向扩展。